image: node:24

stages: [test, build, review, deploy]

variables:
  # Cloudflare
  # CF_PAGES_PROJECT moet worden ingesteld als CI/CD variabele in GitLab
  # Zet deze in: Project Settings ‚Üí CI/CD ‚Üí Variables (bijv. "portfolio-rubenrikk")
  # CLOUDFLARE_API_TOKEN en CLOUDFLARE_ACCOUNT_ID moeten ook worden ingesteld als CI/CD variabelen
  CF_PAGES_BUILD_DIR: "dist"
  # Node/npm
  NPM_CONFIG_FUND: "false"
  NPM_CONFIG_AUDIT: "false"
  # Test reports
  JEST_JUNIT_OUTPUT: "reports/junit.xml"
  CI_JUNIT_REPORT: "reports/junit.xml"

cache:
  key:
    files:
      - package-lock.json
  paths:
    - node_modules/
  policy: pull-push

# ---------------- TESTS ----------------

test:
  stage: test
  script:
    - node -v && npm -v
    - npm ci
    - npm run check
  artifacts:
    when: always
    paths:
      - reports/
      - coverage/
    reports:
      junit: $CI_JUNIT_REPORT
    expire_in: 1 day
  coverage: '/All files[^|]*\s+(\d+\.\d+)%/'
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_PIPELINE_SOURCE == "push"'

lint:
  stage: test
  script:
    - node -v && npm -v
    - npm ci
    - npm run lint || echo "No lint script found, skipping lint check"
  allow_failure: true
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_PIPELINE_SOURCE == "push"'

typecheck:
  stage: test
  script:
    - node -v && npm -v
    - npm ci
    - npm run typecheck || npx astro check || echo "Type checking skipped - no typecheck script available"
  allow_failure: true
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_PIPELINE_SOURCE == "push"'

# ---------------- SECURITY SCANS ----------------

include:
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/Secret-Detection.gitlab-ci.yml
  - template: Security/Dependency-Scanning.gitlab-ci.yml
  - template: Jobs/Code-Quality.gitlab-ci.yml

# Override alleen voor Code Quality: run op runners met tag 'build'
code_quality:
  tags:
    - privileged

.default_script:
  before_script:
    - node -v && npm -v
    - |
      # Probeer npm ci, als het faalt door corrupte cache, gebruik npm install
      if ! npm ci; then
        echo "‚ö†Ô∏è npm ci failed, clearing cache and trying npm install..."
        rm -rf node_modules
        npm install --no-audit --no-fund
      fi
    - |
      # Verifieer dat astro ge√Ønstalleerd is
      if ! command -v astro &> /dev/null && [ ! -f node_modules/.bin/astro ]; then
        echo "‚ùå Astro not found, reinstalling..."
        npm install astro --no-save
      fi
    - npm run build
    - npm i -g wrangler

build:
  stage: build
  needs: 
    - job: test
      optional: true
    - job: lint
      optional: true
    - job: typecheck
      optional: true
  extends: .default_script
  script:
    - echo "Build done ‚Üí artifact in ${CF_PAGES_BUILD_DIR}"
  artifacts:
    paths:
      - ${CF_PAGES_BUILD_DIR}
    expire_in: 1 day
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_PIPELINE_SOURCE == "push"'

review:
  stage: review
  needs: ["build"]
  before_script:
    - node -v && npm -v
    - npm i -g wrangler
    # Verifieer dat vereiste Cloudflare variabelen zijn ingesteld
    - |
      if [ -z "$CLOUDFLARE_API_TOKEN" ]; then
        echo "‚ùå Error: CLOUDFLARE_API_TOKEN is niet ingesteld als CI/CD variabele"
        echo "Zet deze in: Project Settings ‚Üí CI/CD ‚Üí Variables"
        exit 1
      fi
      if [ -z "$CLOUDFLARE_ACCOUNT_ID" ]; then
        echo "‚ùå Error: CLOUDFLARE_ACCOUNT_ID is niet ingesteld als CI/CD variabele"
        echo "Zet deze in: Project Settings ‚Üí CI/CD ‚Üí Variables"
        echo "Je vindt je Account ID in het Cloudflare Dashboard rechtsonder op de overzichtspagina"
        exit 1
      fi
      echo "‚úÖ Cloudflare authenticatie variabelen zijn ingesteld"
      echo "CLOUDFLARE_ACCOUNT_ID lengte: ${#CLOUDFLARE_ACCOUNT_ID} tekens"
  script:
    - |
      # Valideer en trim project naam
      if [ -z "${CF_PAGES_PROJECT}" ] || [ "${CF_PAGES_PROJECT}" = '$CF_PAGES_PROJECT' ]; then
        echo "‚ùå Error: CF_PAGES_PROJECT is niet ingesteld als CI/CD variabele"
        echo "Zet deze in: Project Settings ‚Üí CI/CD ‚Üí Variables (bijv. 'portfolio-rubenrikk')"
        exit 1
      fi
      
      # Trim whitespace
      CF_PAGES_PROJECT=$(echo "${CF_PAGES_PROJECT}" | xargs)
      echo "üîç Controleren of Cloudflare Pages project bestaat: '${CF_PAGES_PROJECT}'"
      echo "üìè Project naam lengte: ${#CF_PAGES_PROJECT} tekens"
      
      # Valideer project naam format (lowercase, letters, cijfers, en streepjes)
      if ! echo "${CF_PAGES_PROJECT}" | grep -qE '^[a-z0-9-]+$'; then
        echo "‚ùå Error: CF_PAGES_PROJECT bevat ongeldige tekens. Alleen lowercase letters, cijfers en streepjes zijn toegestaan."
        exit 1
      fi
      
      # Valideer dat naam niet begint of eindigt met streepje
      if [[ "${CF_PAGES_PROJECT}" =~ ^- ]] || [[ "${CF_PAGES_PROJECT}" =~ -$ ]]; then
        echo "‚ùå Error: CF_PAGES_PROJECT mag niet beginnen of eindigen met een streepje"
        exit 1
      fi
      
      # Probeer project aan te maken; negeer fout als het al bestaat
      echo "üì¶ Controleren/aanmaken Cloudflare Pages project '${CF_PAGES_PROJECT}'"
      set +e
      CREATE_OUTPUT=$(wrangler pages project create "${CF_PAGES_PROJECT}" --production-branch main 2>&1)
      CREATE_STATUS=$?
      set -e
      if [ $CREATE_STATUS -ne 0 ]; then
        if echo "$CREATE_OUTPUT" | grep -qi "already exists"; then
          echo "‚úÖ Project '${CF_PAGES_PROJECT}' bestaat al"
        else
          echo "‚ùå Fout bij aanmaken project:"
          echo "$CREATE_OUTPUT"
          exit 1
        fi
      else
        echo "‚úÖ Project '${CF_PAGES_PROJECT}' aangemaakt"
      fi
    - |
      # Injecteer projectnaam in bestaande wrangler.toml (Pages ondersteunt geen custom --config pad)
      echo "name = \"${CF_PAGES_PROJECT}\"" > wrangler.name.ci.toml
      cat wrangler.name.ci.toml wrangler.toml > wrangler.toml.ci && mv wrangler.toml.ci wrangler.toml

      # Deploy en extraheer deployment URL (niet de alias URL die wordt afgekort)
      DEPLOY_OUTPUT=$(wrangler pages deploy "${CF_PAGES_BUILD_DIR}" \
        --project-name "${CF_PAGES_PROJECT}" \
        --branch "${CI_COMMIT_REF_SLUG}" \
        --commit-hash "${CI_COMMIT_SHA}" \
        --commit-message "${CI_COMMIT_MESSAGE}" 2>&1)
      
      echo "$DEPLOY_OUTPUT"
      
      # Extraheer deployment URL uit output (zoek naar "Deployment complete! Take a peek over at")
      DEPLOYMENT_URL=$(echo "$DEPLOY_OUTPUT" | grep -oP 'https://[a-f0-9]+\.'"${CF_PAGES_PROJECT}"'\.pages\.dev' | head -1)
      
      if [ -z "$DEPLOYMENT_URL" ]; then
        echo "‚ö†Ô∏è Kon deployment URL niet extraheren, gebruik fallback alias URL"
        DEPLOYMENT_URL="https://${CI_COMMIT_REF_SLUG}.${CF_PAGES_PROJECT}.pages.dev"
      fi
      
      echo "üåê Deployment URL: $DEPLOYMENT_URL"
      echo "$DEPLOYMENT_URL" > deployment-url.txt
      
      # Update environment URL via GitLab API (gebruik environment naam)
      # Dit is optioneel - als het faalt is het niet kritisch
      set +e
      if [ -n "$CI_API_V4_URL" ] && [ -n "$CI_JOB_TOKEN" ]; then
        ENV_NAME="review/$CI_COMMIT_REF_SLUG"
        echo "üîÑ Updating environment URL to deployment URL..."
        # Haal environment ID op via naam
        ENV_RESPONSE=$(curl -sS -w "\nHTTP_STATUS:%{http_code}" --header "PRIVATE-TOKEN: $CI_JOB_TOKEN" \
          "$CI_API_V4_URL/projects/$CI_PROJECT_ID/environments?name=$(echo "$ENV_NAME" | sed 's/\//%2F/g')")
        HTTP_STATUS=$(echo "$ENV_RESPONSE" | grep "HTTP_STATUS:" | cut -d: -f2)
        ENV_BODY=$(echo "$ENV_RESPONSE" | sed '/HTTP_STATUS:/d')
        
        if [ "$HTTP_STATUS" = "200" ]; then
          ENV_ID=$(echo "$ENV_BODY" | grep -oP '"id":\s*\K[0-9]+' | head -1)
          
          if [ -n "$ENV_ID" ]; then
            UPDATE_RESPONSE=$(curl -sS -w "\nHTTP_STATUS:%{http_code}" --request PUT \
              --header "PRIVATE-TOKEN: $CI_JOB_TOKEN" \
              --header "Content-Type: application/json" \
              --data "{\"external_url\": \"$DEPLOYMENT_URL\"}" \
              "$CI_API_V4_URL/projects/$CI_PROJECT_ID/environments/$ENV_ID")
            UPDATE_HTTP_STATUS=$(echo "$UPDATE_RESPONSE" | grep "HTTP_STATUS:" | cut -d: -f2)
            
            if [ "$UPDATE_HTTP_STATUS" = "200" ]; then
              echo "‚úÖ Environment URL succesvol bijgewerkt naar: $DEPLOYMENT_URL"
            else
              echo "‚ö†Ô∏è Kon environment URL niet updaten (HTTP $UPDATE_HTTP_STATUS) - niet kritisch"
            fi
          else
            echo "‚ö†Ô∏è Kon environment ID niet vinden in response - niet kritisch"
          fi
        else
          echo "‚ö†Ô∏è Kon environment niet ophalen (HTTP $HTTP_STATUS) - niet kritisch"
        fi
      else
        echo "‚ö†Ô∏è CI_API_V4_URL of CI_JOB_TOKEN niet beschikbaar - niet kritisch"
      fi
      set -e
  artifacts:
    paths:
      - deployment-url.txt
    expire_in: 1 day
  environment:
    name: "review/$CI_COMMIT_REF_SLUG"
    url: "https://${CI_COMMIT_REF_SLUG}.${CF_PAGES_PROJECT}.pages.dev"
    on_stop: "stop_review"
  rules:
    - if: '$CI_MERGE_REQUEST_IID'   # alleen bij MR's

smoke_test_review:
  stage: review
  image: curlimages/curl:latest
  needs: 
    - job: "review"
      artifacts: true
  script: |
    # Lees deployment URL uit artifact (niet de alias URL die wordt afgekort)
    if [ -f deployment-url.txt ]; then
      URL=$(cat deployment-url.txt)
      echo "üìÑ Deployment URL gelezen uit artifact: $URL"
    else
      echo "‚ö†Ô∏è deployment-url.txt niet gevonden, gebruik fallback alias URL"
      URL="https://${CI_COMMIT_REF_SLUG}.${CF_PAGES_PROJECT}.pages.dev"
    fi
    
    echo "üîé Running smoke test against $URL"
    
    # Wait for deployment to respond
    for i in {1..20}; do
      if curl -fs "$URL" > /dev/null 2>&1; then
        echo "‚úÖ Smoke test passed - site is accessible"
        exit 0
      fi
      echo "‚è≥ Waiting for application... (attempt $i/20)"
      sleep 5
    done
    
    echo "‚ùå Smoke test failed ‚Äî site not responding"
    exit 1
  rules:
    - if: '$CI_MERGE_REQUEST_IID'
  allow_failure: true

# Op Pages worden previews automatisch opgeruimd; stop job alleen als je handmatig wilt opschonen.

stop_review:
  stage: review
  script:
    - echo "Preview environments op Cloudflare Pages worden automatisch beheerd. Geen actie nodig."
  when: manual
  allow_failure: true
  rules:
    - if: '$CI_MERGE_REQUEST_IID'
  environment:
    name: "review/$CI_COMMIT_REF_SLUG"
    action: stop

deploy_production:
  stage: deploy
  needs: ["build"]
  before_script:
    - node -v && npm -v
    - npm i -g wrangler
    # Verifieer dat vereiste Cloudflare variabelen zijn ingesteld
    - |
      if [ -z "$CLOUDFLARE_API_TOKEN" ]; then
        echo "‚ùå Error: CLOUDFLARE_API_TOKEN is niet ingesteld als CI/CD variabele"
        echo "Zet deze in: Project Settings ‚Üí CI/CD ‚Üí Variables"
        exit 1
      fi
      if [ -z "$CLOUDFLARE_ACCOUNT_ID" ]; then
        echo "‚ùå Error: CLOUDFLARE_ACCOUNT_ID is niet ingesteld als CI/CD variabele"
        echo "Zet deze in: Project Settings ‚Üí CI/CD ‚Üí Variables"
        echo "Je vindt je Account ID in het Cloudflare Dashboard rechtsonder op de overzichtspagina"
        exit 1
      fi
      echo "‚úÖ Cloudflare authenticatie variabelen zijn ingesteld"
      echo "CLOUDFLARE_ACCOUNT_ID lengte: ${#CLOUDFLARE_ACCOUNT_ID} tekens"
  script:
    - |
      # Valideer en trim project naam
      if [ -z "${CF_PAGES_PROJECT}" ] || [ "${CF_PAGES_PROJECT}" = '$CF_PAGES_PROJECT' ]; then
        echo "‚ùå Error: CF_PAGES_PROJECT is niet ingesteld als CI/CD variabele"
        echo "Zet deze in: Project Settings ‚Üí CI/CD ‚Üí Variables (bijv. 'portfolio-rubenrikk')"
        exit 1
      fi
      
      # Trim whitespace
      CF_PAGES_PROJECT=$(echo "${CF_PAGES_PROJECT}" | xargs)
      echo "üîç Controleren of Cloudflare Pages project bestaat: '${CF_PAGES_PROJECT}'"
      echo "üìè Project naam lengte: ${#CF_PAGES_PROJECT} tekens"
      
      # Valideer project naam format (lowercase, letters, cijfers, en streepjes)
      if ! echo "${CF_PAGES_PROJECT}" | grep -qE '^[a-z0-9-]+$'; then
        echo "‚ùå Error: CF_PAGES_PROJECT bevat ongeldige tekens. Alleen lowercase letters, cijfers en streepjes zijn toegestaan."
        exit 1
      fi
      
      # Valideer dat naam niet begint of eindigt met streepje
      if [[ "${CF_PAGES_PROJECT}" =~ ^- ]] || [[ "${CF_PAGES_PROJECT}" =~ -$ ]]; then
        echo "‚ùå Error: CF_PAGES_PROJECT mag niet beginnen of eindigen met een streepje"
        exit 1
      fi
      
      # Probeer project aan te maken; negeer fout als het al bestaat
      echo "üì¶ Controleren/aanmaken Cloudflare Pages project '${CF_PAGES_PROJECT}'"
      set +e
      CREATE_OUTPUT=$(wrangler pages project create "${CF_PAGES_PROJECT}" --production-branch main 2>&1)
      CREATE_STATUS=$?
      set -e
      if [ $CREATE_STATUS -ne 0 ]; then
        if echo "$CREATE_OUTPUT" | grep -qi "already exists"; then
          echo "‚úÖ Project '${CF_PAGES_PROJECT}' bestaat al"
        else
          echo "‚ùå Fout bij aanmaken project:"
          echo "$CREATE_OUTPUT"
          exit 1
        fi
      else
        echo "‚úÖ Project '${CF_PAGES_PROJECT}' aangemaakt"
      fi
    - |
      # Injecteer projectnaam in bestaande wrangler.toml (Pages ondersteunt geen custom --config pad)
      echo "name = \"${CF_PAGES_PROJECT}\"" > wrangler.name.ci.toml
      cat wrangler.name.ci.toml wrangler.toml > wrangler.toml.ci && mv wrangler.toml.ci wrangler.toml

      # Bereken de productie URL voor logging
      if [ -n "$CF_PAGES_PRODUCTION_DOMAIN" ]; then
        PROD_URL="https://$CF_PAGES_PRODUCTION_DOMAIN"
      else
        PROD_URL="https://${CF_PAGES_PROJECT}.pages.dev"
      fi
      
      echo "üåê Production URL: $PROD_URL"
      
      # Deploy en log output (voor productie is de URL meestal de definitieve productie URL)
      DEPLOY_OUTPUT=$(wrangler pages deploy "${CF_PAGES_BUILD_DIR}" \
        --project-name "${CF_PAGES_PROJECT}" \
        --branch "main" \
        --commit-hash "${CI_COMMIT_SHA}" \
        --commit-message "${CI_COMMIT_MESSAGE}" 2>&1)
      
      echo "$DEPLOY_OUTPUT"
      
      # Voor productie gebruiken we de PROD_URL (kan custom domain of .pages.dev zijn)
      # Sla deze op voor de smoke test
      echo "$PROD_URL" > deployment-url.txt
      
      echo "‚úÖ Deployed to: $PROD_URL"
  artifacts:
    paths:
      - deployment-url.txt
    expire_in: 1 day
  environment:
    name: production
    url: "https://turnenhengelo.nl"
    action: start
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

smoke_test_production:
  stage: deploy
  image: curlimages/curl:latest
  needs: 
    - job: "deploy_production"
      artifacts: true
  script: |
    # Lees deployment URL uit artifact (consistent met review smoke test)
    if [ -f deployment-url.txt ]; then
      URL=$(cat deployment-url.txt)
      echo "üìÑ Production URL gelezen uit artifact: $URL"
    else
      # Fallback naar CF_PAGES_PRODUCTION_DOMAIN of CF_PAGES_PROJECT.pages.dev
      if [ -n "$CF_PAGES_PRODUCTION_DOMAIN" ]; then
        URL="https://$CF_PAGES_PRODUCTION_DOMAIN"
      else
        URL="https://${CF_PAGES_PROJECT}.pages.dev"
      fi
      echo "‚ö†Ô∏è deployment-url.txt niet gevonden, gebruik fallback: $URL"
    fi
    
    echo "üîé Running smoke test tegen productie: $URL"
    
    # Wait for deployment to respond
    for i in {1..20}; do
      if curl -fs "$URL" > /dev/null 2>&1; then
        echo "‚úÖ Smoke test passed - production site is accessible"
        exit 0
      fi
      echo "‚è≥ Waiting for production deployment... (attempt $i/20)"
      sleep 5
    done
    
    echo "‚ùå Smoke test failed ‚Äî production site not responding"
    exit 1
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  allow_failure: true
